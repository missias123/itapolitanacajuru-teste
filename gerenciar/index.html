<!-- cache-bust: 1772036242 -->
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë         SORVETERIA ITAPOLITANA CAJURU ‚Äî SITE OFICIAL         ‚ïë
  ‚ïë‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë
  ‚ïë  Criado por: Sgt Missiascacarato                             ‚ïë
  ‚ïë  Data de cria√ß√£o: Fevereiro de 2026                          ‚ïë
  ‚ïë  Vers√£o: 2.0 ‚Äî Sistema de Design Padronizado                 ‚ïë
  ‚ïë  Tecnologia: HTML5 + CSS3 + JavaScript Vanilla               ‚ïë
  ‚ïë  Hospedagem: GitHub Pages                                    ‚ïë
  ‚ïë  Dom√≠nio: itapolitanacajuru.com.br                           ‚ïë
  ‚ïë‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë
  ‚ïë  ¬© 2026 Sorveteria Itapolitana Cajuru. Todos os direitos     ‚ïë
  ‚ïë  reservados. Reprodu√ß√£o proibida sem autoriza√ß√£o.            ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Itapolitana Cajuru</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:#f5f5f8;color:#111827;min-height:100vh}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-box{background:#fff;border-radius:16px;padding:32px 24px;max-width:360px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,.1);text-align:center}
.login-box h2{font-size:20px;font-weight:900;margin-bottom:8px}
.login-box p{font-size:13px;color:#6A0DAD;font-weight:700;margin-bottom:24px}
.login-box input{width:100%;padding:12px 14px;border:1px solid #E5E7EB;border-radius:10px;font-size:15px;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:#6A0DAD}
.btn-login{width:100%;padding:13px;background:#6A0DAD;color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:800;cursor:pointer}
.btn-login:hover{background:#5a0b9d}
.back-link{display:block;margin-top:16px;font-size:13px;color:#6A0DAD;text-decoration:none}
#admin-panel{display:none}
.admin-header{background:#1F2937;color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.admin-header h1{font-size:16px;font-weight:800}
.btn-logout{background:#EF4444;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer}
.admin-body{max-width:960px;margin:0 auto;padding:20px 16px 100px}
.cat-section{background:#fff;border-radius:14px;border:1px solid #E5E7EB;margin-bottom:16px;overflow:hidden}
.cat-header{padding:14px 18px;background:#F9FAFB;border-bottom:1px solid #E5E7EB;display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
.cat-header h3{font-size:15px;font-weight:800;flex:1}
.cat-arrow{font-size:12px;color:#6A0DAD;transition:transform .3s}
.cat-section.open .cat-arrow{transform:rotate(180deg)}
.cat-body{display:none;padding:16px}
.cat-section.open .cat-body{display:block}
.prod-edit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.prod-edit-card{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:10px;padding:14px}
.prod-edit-card h4{font-size:13px;font-weight:800;margin-bottom:10px;color:#111827}
.field-row{display:flex;gap:8px;margin-bottom:8px}
.field-row label{font-size:11px;font-weight:700;color:#6A0DAD;display:block;margin-bottom:3px}
.field-row input{width:100%;padding:7px 10px;border:1px solid #E5E7EB;border-radius:7px;font-size:13px;outline:none}
.field-row input:focus{border-color:#6A0DAD}
.btn-esgotar{width:100%;padding:7px;background:#FEE2E2;color:#EF4444;border:1px solid #FECACA;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;margin-top:4px}
.btn-esgotar.esgotado{background:#EF4444;color:#fff}
.sabores-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.sabor-chip{background:#E3F2FD;color:#1565C0;border:1px solid #90CAF9;border-radius:20px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
.sabor-chip.esgotado{background:#FEE2E2;color:#EF4444;border-color:#FECACA;text-decoration:line-through}
.preco-simples-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.preco-simples-card{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:10px;padding:12px}
.preco-simples-card label{font-size:12px;font-weight:700;color:#374151;display:block;margin-bottom:6px}
.preco-simples-card input{width:100%;padding:8px 10px;border:1px solid #E5E7EB;border-radius:7px;font-size:14px;font-weight:700;outline:none}
.preco-simples-card input:focus{border-color:#6A0DAD}
.save-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #E5E7EB;padding:12px 20px;display:flex;gap:10px;justify-content:center;z-index:200}
.btn-save{background:#6A0DAD;color:#fff;border:none;border-radius:10px;padding:12px 32px;font-size:15px;font-weight:800;cursor:pointer}
.btn-save:hover{background:#5a0b9d}
.status-msg{font-size:13px;font-weight:700;color:#10B981;align-self:center}

/* ‚îÄ‚îÄ CAMPO DE FOTO ‚îÄ‚îÄ */
.foto-bloco{margin-bottom:10px}
.foto-bloco-label{font-size:11px;font-weight:700;color:#6A0DAD;margin-bottom:6px;display:flex;align-items:center;gap:4px}
.foto-area{border:2px dashed #D1D5DB;border-radius:10px;overflow:hidden;background:#fff;cursor:pointer;transition:border-color .2s;position:relative;min-height:100px;display:flex;align-items:center;justify-content:center}
.foto-area:hover{border-color:#6A0DAD}
.foto-area.tem-foto{border:2px solid #10B981}
.foto-area img{width:100%;height:120px;object-fit:cover;display:block}
.foto-placeholder{text-align:center;padding:16px 10px;pointer-events:none}
.foto-placeholder .icone{font-size:28px;margin-bottom:4px}
.foto-placeholder p{font-size:11px;color:#9CA3AF;font-weight:600;line-height:1.4}
.foto-placeholder p span{color:#6A0DAD;font-weight:700}
.foto-input{display:none}
.foto-acoes{display:flex;gap:6px;margin-top:6px}
.btn-trocar-foto{flex:1;padding:6px;background:#EDE9FE;color:#6A0DAD;border:1px solid #C4B5FD;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer}
.btn-remover-foto{flex:1;padding:6px;background:#FEE2E2;color:#EF4444;border:1px solid #FECACA;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer}

/* ‚îÄ‚îÄ VALIDA√á√ÉO EM TEMPO REAL ‚îÄ‚îÄ */
.campo-valido{border-color:#10B981 !important;background:#F0FDF4 !important}
.campo-invalido{border-color:#EF4444 !important;background:#FEF2F2 !important}
.campo-aviso{border-color:#F59E0B !important;background:#FFFBEB !important}
.contador-chars{font-size:11px;font-weight:700;text-align:right;margin-top:3px;transition:color .2s}
.contador-ok{color:#10B981}
.contador-aviso{color:#F59E0B}
.contador-erro{color:#EF4444}
.erro-inline{font-size:11px;font-weight:700;color:#EF4444;margin-top:3px;display:none}
.erro-inline.visivel{display:block}

/* ‚îÄ‚îÄ PAINEL DE DIAGN√ìSTICO ‚îÄ‚îÄ */
#painel-diagnostico{background:#fff;border-radius:14px;border:2px solid #3B82F6;padding:18px 20px;margin-bottom:16px;display:none}
#painel-diagnostico.aberto{display:block}
.diag-titulo{font-size:16px;font-weight:900;color:#1D4ED8;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.diag-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:10px;margin-bottom:8px;font-size:13px;font-weight:600}
.diag-ok{background:#F0FDF4;border:1px solid #BBF7D0;color:#166534}
.diag-erro{background:#FEF2F2;border:1px solid #FECACA;color:#991B1B}
.diag-aviso{background:#FFFBEB;border:1px solid #FDE68A;color:#92400E}
.diag-info{background:#EFF6FF;border:1px solid #BFDBFE;color:#1E40AF}
.btn-diag{width:100%;background:linear-gradient(135deg,#3B82F6,#1D4ED8);color:#fff;border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:800;cursor:pointer;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-diag:hover{background:linear-gradient(135deg,#2563EB,#1E40AF)}
.btn-autocorrigir{width:100%;background:linear-gradient(135deg,#10B981,#059669);color:#fff;border:none;border-radius:10px;padding:10px;font-size:13px;font-weight:800;cursor:pointer;margin-bottom:8px}
.btn-autocorrigir:hover{background:linear-gradient(135deg,#059669,#047857)}

/* ‚îÄ‚îÄ CAMPO DE RELATO DE ERRO ‚îÄ‚îÄ */
#bloco-relato{background:#FFF7ED;border:2px solid #F59E0B;border-radius:12px;padding:16px;margin-top:12px}
#bloco-relato h4{font-size:14px;font-weight:900;color:#92400E;margin-bottom:10px;display:flex;align-items:center;gap:6px}
#campo-relato-erro{width:100%;padding:10px 12px;border:1.5px solid #FCD34D;border-radius:8px;font-size:13px;resize:vertical;min-height:80px;box-sizing:border-box;font-family:inherit}
#campo-relato-erro:focus{outline:none;border-color:#F59E0B}
.btn-enviar-relato{width:100%;background:linear-gradient(135deg,#F59E0B,#D97706);color:#fff;border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:800;cursor:pointer;margin-top:8px}
.btn-enviar-relato:hover{background:linear-gradient(135deg,#D97706,#B45309)}
#relato-status{font-size:12px;font-weight:700;color:#10B981;text-align:center;margin-top:8px;min-height:18px}
</style>
</head>
<body>
<div class="login-wrap" id="login-section">
  <div class="login-box">
    <h2>‚öôÔ∏è Painel Admin</h2>
    <p>Sorveteria Itapolitana Cajuru</p>
    <div style="position:relative;width:100%;margin-bottom:12px">
      <input type="password" id="admin-password" placeholder="Senha administrativa" onkeypress="if(event.key==='Enter')checkLogin()" style="width:100%;padding:12px 44px 12px 14px;border:1px solid #E5E7EB;border-radius:10px;font-size:15px;outline:none;box-sizing:border-box">
      <button type="button" id="btn-olho" onclick="toggleSenha()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:20px;color:#6A0DAD;padding:0;line-height:1" title="Mostrar/ocultar senha">üëÅÔ∏è</button>
    </div>
    <button type="button" class="btn-login" onclick="checkLogin()">Entrar</button>
    <a href="../index.html" class="back-link">‚Üê Voltar ao site</a>
  </div>
</div>
<div id="admin-panel">
  <div class="admin-header">
    <h1>‚öôÔ∏è Gerenciamento ‚Äì Itapolitana Cajuru</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button type="button" onclick="toggleDiagnostico()" id="btn-abrir-diag" style="background:#3B82F6;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer">üîç Diagn√≥stico</button>
      <button type="button" class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;gap:10px;padding:16px;background:#F9FAFB;border-bottom:1px solid #E5E7EB">
    <a href="./cardapio/" style="display:flex;align-items:center;gap:14px;padding:16px 18px;background:linear-gradient(135deg,#7B1FA2,#9C27B0);color:#fff;border-radius:14px;font-size:15px;font-weight:800;text-decoration:none;box-shadow:0 4px 14px rgba(123,31,162,.35)">
      <span style="font-size:28px;line-height:1">üç¶</span>
      <div><div style="font-size:15px;font-weight:800">Admin Card√°pio</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:2px">Pre√ßos e produtos do card√°pio</div></div>
      <span style="margin-left:auto;font-size:18px">‚Ä∫</span>
    </a>
    <a href="./encomendas/" style="display:flex;align-items:center;gap:14px;padding:16px 18px;background:linear-gradient(135deg,#E53935,#C62828);color:#fff;border-radius:14px;font-size:15px;font-weight:800;text-decoration:none;box-shadow:0 4px 14px rgba(229,57,53,.35)">
      <span style="font-size:28px;line-height:1">üì¶</span>
      <div><div style="font-size:15px;font-weight:800">Admin Encomendas</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:2px">Caixas, tortas e picol√©s</div></div>
      <span style="margin-left:auto;font-size:18px">‚Ä∫</span>
    </a>
    <a href="./estoque.html" style="display:flex;align-items:center;gap:14px;padding:16px 18px;background:linear-gradient(135deg,#1F2937,#374151);color:#fff;border-radius:14px;font-size:15px;font-weight:800;text-decoration:none;box-shadow:0 4px 14px rgba(31,41,55,.35)">
      <span style="font-size:28px;line-height:1">üßä</span>
      <div><div style="font-size:15px;font-weight:800">Admin Estoque</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:2px">Insumos e materiais internos</div></div>
      <span style="margin-left:auto;font-size:18px">‚Ä∫</span>
    </a>
    <a href="./pedidos/" style="display:flex;align-items:center;gap:14px;padding:16px 18px;background:linear-gradient(135deg,#065F46,#059669);color:#fff;border-radius:14px;font-size:15px;font-weight:800;text-decoration:none;box-shadow:0 4px 14px rgba(5,150,105,.35)">
      <span style="font-size:28px;line-height:1">üìã</span>
      <div><div style="font-size:15px;font-weight:800">Pedidos Recebidos</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:2px">Ver, atualizar e excluir pedidos de encomenda</div></div>
      <span style="margin-left:auto;font-size:18px">‚Ä∫</span>
    </a>
  </div>
  <!-- PAINEL DE DIAGN√ìSTICO -->
  <div id="painel-diagnostico">
    <div class="diag-titulo">üîç Diagn√≥stico do Sistema</div>
    <div id="diag-resultados"><div class="diag-item diag-info"><span>‚è≥</span><span>Executando diagn√≥stico...</span></div></div>
    <button type="button" class="btn-autocorrigir" onclick="autoCorrigir()" id="btn-autocorrigir" style="display:none">üîß Auto-Corrigir Erros Detectados</button>
    <div id="bloco-relato">
      <h4>üö® Descrever um Problema</h4>
      <p style="font-size:12px;color:#92400E;margin-bottom:8px">Descreva o que est√° acontecendo de errado. O relato ser√° enviado automaticamente com os dados t√©cnicos do sistema.</p>
      <textarea id="campo-relato-erro" placeholder="Ex: A foto da promo√ß√£o n√£o aparece no site, o t√≠tulo est√° errado, o bot√£o n√£o funciona..."></textarea>
      <button type="button" class="btn-enviar-relato" onclick="enviarRelato()">üì§ Enviar Relato via WhatsApp</button>
      <div id="relato-status"></div>
    </div>
  </div>
  <div class="admin-body" id="admin-body"></div>
  <div class="save-bar">
    <span class="status-msg" id="status-msg"></span>
    <button type="button" class="btn-save" onclick="salvarTudo()" id="btn-salvar-tudo">‚òÅÔ∏è Sincronizar com o Site</button>
  </div>
</div>
<script src="../scripts/products.js"></script>
<script>
const ADMIN_PASS = "itapolitana2007";
const ADMIN_SOS = "sos2007"; // Senha de emerg√™ncia ‚Äî entra e auto-corrige bugs
function toggleSenha() {
  const inp = document.getElementById('admin-password');
  const btn = document.getElementById('btn-olho');
  if (inp.type === 'password') {
    inp.type = 'text';
    btn.textContent = 'üôà';
  } else {
    inp.type = 'password';
    btn.textContent = 'üëÅÔ∏è';
  }
}
function getFotos() {
  try { return JSON.parse(localStorage.getItem('itap_fotos') || '{}'); } catch(e){ return {}; }
}
function salvarFoto(chave, base64) {
  const fotos = getFotos();
  fotos[chave] = base64;
  localStorage.setItem('itap_fotos', JSON.stringify(fotos));
}
function removerFoto(chave) {
  const fotos = getFotos();
  delete fotos[chave];
  localStorage.setItem('itap_fotos', JSON.stringify(fotos));
}
function blocoFoto(chave) {
  const fotos = getFotos();
  const temFoto = !!fotos[chave];
  const imgSrc = temFoto ? fotos[chave] : '';
  return `
    <div class="foto-bloco" id="foto-bloco-${chave}">
      <div class="foto-bloco-label">üì∑ Foto do Produto</div>
      <div style="background:#F0FDF4;border:1px solid #BBF7D0;border-radius:7px;padding:7px 10px;margin-bottom:6px;font-size:11px;color:#166534;font-weight:700;line-height:1.5">
        üìê Ideal: 400√ó220 px ¬∑ JPG/PNG ¬∑ m√°x. 300 KB
      </div>
      <div class="foto-area ${temFoto ? 'tem-foto' : ''}" onclick="document.getElementById('foto-input-${chave}').click()">
        ${temFoto
          ? `<img src="${imgSrc}" alt="Foto" id="foto-img-${chave}">`
          : `<div class="foto-placeholder" id="foto-placeholder-${chave}"><div class="icone">üì∑</div><p>Toque para<br><span>adicionar foto</span></p></div>`
        }
      </div>
      <input type="file" accept="image/*" class="foto-input" id="foto-input-${chave}"
        onchange="onFotoChange('${chave}', this)">
      ${temFoto ? `
      <div class="foto-acoes" id="foto-acoes-${chave}">
        <button type="button" class="btn-trocar-foto" onclick="document.getElementById('foto-input-${chave}').click()">üîÑ Trocar</button>
        <button type="button" class="btn-remover-foto" onclick="onRemoverFoto('${chave}')">üóëÔ∏è Remover</button>
      </div>` : `<div class="foto-acoes" id="foto-acoes-${chave}" style="display:none">
        <button type="button" class="btn-trocar-foto" onclick="document.getElementById('foto-input-${chave}').click()">üîÑ Trocar</button>
        <button type="button" class="btn-remover-foto" onclick="onRemoverFoto('${chave}')">üóëÔ∏è Remover</button>
      </div>`}
    </div>`;
}

function onFotoChange(chave, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;
    salvarFoto(chave, base64);
    // Atualizar UI
    const area = input.closest('.foto-area') || input.parentElement.querySelector('.foto-area');
    const blocoEl = document.getElementById('foto-bloco-' + chave);
    const fotoArea = blocoEl.querySelector('.foto-area');
    fotoArea.classList.add('tem-foto');
    fotoArea.innerHTML = `<img src="${base64}" alt="Foto" id="foto-img-${chave}">`;
    const acoes = document.getElementById('foto-acoes-' + chave);
    acoes.style.display = 'flex';
    // Reatribuir onclick ao trocar
    fotoArea.onclick = () => document.getElementById('foto-input-' + chave).click();
  };
  reader.readAsDataURL(file);
}

function onRemoverFoto(chave) {
  removerFoto(chave);
  const blocoEl = document.getElementById('foto-bloco-' + chave);
  const fotoArea = blocoEl.querySelector('.foto-area');
  fotoArea.classList.remove('tem-foto');
  fotoArea.innerHTML = `<div class="foto-placeholder" id="foto-placeholder-${chave}"><div class="icone">üì∑</div><p>Toque para<br><span>adicionar foto</span></p></div>`;
  fotoArea.onclick = () => document.getElementById('foto-input-' + chave).click();
  const acoes = document.getElementById('foto-acoes-' + chave);
  acoes.style.display = 'none';
}
function onBannerChange(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    const imgBase64 = e.target.result;
    const preview = document.getElementById('banner-preview-area');
    if (preview) preview.innerHTML = `<img src="${imgBase64}" style="width:100%;max-height:180px;object-fit:cover;border-radius:10px;display:block">`;
    const status = document.getElementById('banner-status');
    if (status) status.textContent = '‚è≥ Publicando banner no site...';
    // Limpa caches antigos antes de publicar novo banner
    limparTodosCaches();
    try {
      let dadosAtuais = {};
      try { const r = await fetch('https://raw.githubusercontent.com/missias123/itapolitanacajuru/main/dados/promo.json?t='+Date.now()); if (r.ok) dadosAtuais = await r.json(); } catch(ex) {}
      dadosAtuais.bannerImg = imgBase64;
      const resp = await fetch('https://5050-iws6e208zbbi8wf5hdl9t-69161701.us2.manus.computer/update-promo', {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-Admin-Key':'itap2007sync'},
        body: JSON.stringify(dadosAtuais)
      });
      const result = await resp.json();
      if (result.status === 'ok') {
        if (status) { status.textContent = '‚úÖ Banner publicado no site para todos!'; setTimeout(() => status.textContent = '', 5000); }
      } else {
        if (status) status.textContent = '‚ùå Erro: ' + (result.error || 'desconhecido');
      }
    } catch(err) {
      if (status) status.textContent = '‚ùå Erro de conex√£o: ' + err.message;
    }
  };
  reader.readAsDataURL(file);
}

function removerBanner() {
  (async () => {
    try {
      let d = {};
      try { const r = await fetch('https://raw.githubusercontent.com/missias123/itapolitanacajuru/main/dados/promo.json?t='+Date.now()); if (r.ok) d = await r.json(); } catch(e) {}
      delete d.bannerImg;
      await fetch('https://5050-iws6e208zbbi8wf5hdl9t-69161701.us2.manus.computer/update-promo', {method:'POST',headers:{'Content-Type':'application/json','X-Admin-Key':'itap2007sync'},body:JSON.stringify(d)});
    } catch(e) {}
  })();
  localStorage.removeItem('itap_banner_cache');
  renderAdmin();
}
function checkLogin() {
  const p = document.getElementById('admin-password').value;
  if (p === ADMIN_PASS) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    // Carregar dados remotos do promo.json para popular localStorage
    (async () => {
      try {
        const r = await fetch('https://raw.githubusercontent.com/missias123/itapolitanacajuru/main/dados/promo.json?t='+Date.now());
        if (r.ok) {
          const d = await r.json();
          const local = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
          localStorage.setItem('itap_promo_local', JSON.stringify(Object.assign({}, local)));
          renderAdmin();
        }
      } catch(e) {}
    })();
    renderAdmin();
  } else if (p === ADMIN_SOS) {
    // Modo SOS: entra, corrige cache, aciona redeploy e avisa WhatsApp
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    renderAdmin();
    setTimeout(async () => {
      const sosDiv = document.createElement('div');
      sosDiv.id = 'sos-banner';
      sosDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#EF4444;color:#fff;padding:14px 18px;font-size:14px;font-weight:800;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,.4)';
      sosDiv.innerHTML = 'üÜò Modo SOS ativado ‚Äî Detectando e corrigindo problemas...';
      document.body.prepend(sosDiv);
      // 1. Auto-corre√ß√£o: limpar caches corrompidos
      const chavesCorrompidas = [];
      const chaves = ['itap_promo','itap_promo_cache','itap_promo_local','itap_banner','itap_banner_cache','itap_produtos_nuvem','itap_fotos','itap_sabores','itap_caixas_enc','itap_tortas_enc','itap_complementos','itap_acrescimos','itap_pedidos','itap_seq_pedido','pwa_dispensado'];
      chaves.forEach(k => {
        try { const v = localStorage.getItem(k); if (v) JSON.parse(v); }
        catch(e) { localStorage.removeItem(k); chavesCorrompidas.push(k); }
      });
      // 2. Verificar fun√ß√µes principais
      const problemas = [];
      if (typeof renderAdmin !== 'function') problemas.push('renderAdmin n√£o carregou');
      if (typeof salvarPromo !== 'function') problemas.push('salvarPromo n√£o carregou');
      if (chavesCorrompidas.length > 0) problemas.push('Cache corrompido limpo: ' + chavesCorrompidas.join(', '));
      // 3. Acionar redeploy do GitHub Pages via Gist config
      let redeployOk = false;
      try {
        const cfgResp = await fetch('https://gist.githubusercontent.com/missias123/832853392f412ef307695de249ea969c/raw/sos-config.json?t=' + Date.now());
        const cfg = await cfgResp.json();
        // Pegar SHA atual
        const refResp = await fetch('https://api.github.com/repos/' + cfg.repo + '/git/refs/heads/' + cfg.branch, {headers:{'Authorization':'Bearer ' + cfg.token,'Accept':'application/vnd.github+json'}});
        const refData = await refResp.json();
        const sha = refData.object.sha;
        // Pegar tree do commit
        const commitResp = await fetch('https://api.github.com/repos/' + cfg.repo + '/git/commits/' + sha, {headers:{'Authorization':'Bearer ' + cfg.token,'Accept':'application/vnd.github+json'}});
        const commitData = await commitResp.json();
        const tree = commitData.tree.sha;
        // Criar commit vazio
        const newCommitResp = await fetch('https://api.github.com/repos/' + cfg.repo + '/git/commits', {method:'POST',headers:{'Authorization':'Bearer ' + cfg.token,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify({message:'chore: SOS redeploy ' + new Date().toISOString(),tree:tree,parents:[sha]})});
        const newCommit = await newCommitResp.json();
        // Atualizar ref
        await fetch('https://api.github.com/repos/' + cfg.repo + '/git/refs/heads/' + cfg.branch, {method:'PATCH',headers:{'Authorization':'Bearer ' + cfg.token,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify({sha:newCommit.sha,force:false})});
        redeployOk = true;
      } catch(e) { problemas.push('Redeploy falhou: ' + e.message); }
      // 4. Enviar alerta WhatsApp
      const hora = new Date().toLocaleString('pt-BR', {timeZone:'America/Sao_Paulo'});
      const status = problemas.length === 0 ? 'Tudo OK' : problemas.join(' | ');
      const msg = 'üÜò *SOS Itapolitana Admin*\n' + hora + '\n\n' + (problemas.length === 0 ? '‚úÖ Nenhum problema encontrado. Site funcionando normalmente.' : '‚ö†Ô∏è Problemas detectados e corrigidos:\n' + problemas.map(p=>'‚Ä¢ '+p).join('\n')) + (redeployOk ? '\n\nüîÑ Redeploy do site acionado com sucesso.' : '');
      const wppUrl = 'https://wa.me/5516996291903?text=' + encodeURIComponent(msg);
      // 5. Exibir resultado
      setTimeout(() => {
        if (problemas.length === 0) {
          sosDiv.style.background = '#16A34A';
          sosDiv.innerHTML = '‚úÖ SOS: Tudo OK! ' + (redeployOk ? 'Redeploy acionado. ' : '') + '<a href="' + wppUrl + '" target="_blank" style="margin-left:10px;background:#fff;color:#16A34A;border-radius:6px;padding:4px 12px;font-weight:800;text-decoration:none">üì≤ Ver no WhatsApp</a> <button onclick="this.parentElement.remove()" style="margin-left:8px;background:rgba(255,255,255,.3);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-weight:800;cursor:pointer">Fechar</button>';
        } else {
          sosDiv.style.background = '#D97706';
          sosDiv.innerHTML = '‚ö†Ô∏è SOS: Corrigido! ' + problemas.length + ' problema(s). ' + (redeployOk ? 'üîÑ Redeploy acionado. ' : '') + '<a href="' + wppUrl + '" target="_blank" style="margin-left:10px;background:#fff;color:#D97706;border-radius:6px;padding:4px 12px;font-weight:800;text-decoration:none">üì≤ Relat√≥rio WhatsApp</a> <button onclick="location.reload()" style="margin-left:8px;background:rgba(255,255,255,.3);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-weight:800;cursor:pointer">Recarregar</button>';
        }
      }, 2000);
    }, 500);
  } else { alert('Senha incorreta!'); }
}
function logout() { location.reload(); }
function toggleCat(id) { document.getElementById('cat-' + id).classList.toggle('open'); }
function criarSecao(id, titulo, conteudo) {
  const s = document.createElement('div');
  s.className = 'cat-section'; s.id = 'cat-' + id;
  s.innerHTML = `<div class="cat-header" onclick="toggleCat('${id}')"><h3>${titulo}</h3><span class="cat-arrow">‚ñº</span></div><div class="cat-body">${conteudo}</div>`;
  return s;
}
function renderAdmin() {
  const body = document.getElementById('admin-body'); body.innerHTML = '';
  const promoCard = document.createElement('div');
  promoCard.style.cssText = 'background:#fff;border-radius:14px;border:2px solid #E8000D;padding:18px 20px;margin-bottom:16px';
  const _ps = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
  const _fotoUrl = _ps.fotoUrl || '';
  promoCard.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <span style="font-size:26px">üéâ</span>
      <div>
        <div style="font-size:16px;font-weight:900;color:#E8000D">Gerenciar Promo√ß√£o</div>
        <div style="font-size:12px;color:#6B7280;margin-top:2px">Edite e clique em Postar para publicar no site</div>
      </div>
    </div>
    <div style="margin-bottom:12px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:6px">üì∑ Foto da Promo√ß√£o</div>
      <div id="promo-foto-preview" style="border-radius:10px;overflow:hidden;margin-bottom:8px;${_fotoUrl ? '' : 'display:none'}">
        <img src="${_fotoUrl}" style="width:100%;max-height:200px;object-fit:contain;display:block;background:#111" id="promo-foto-img">
        <div style="text-align:center;padding:5px;background:#111;font-size:11px;color:#10B981;font-weight:700">‚úÖ Foto publicada no site</div>
      </div>
      <div id="promo-foto-status" style="text-align:center;font-size:12px;font-weight:700;color:#6B7280;margin-bottom:8px"></div>
      <label style="display:flex;align-items:center;justify-content:center;gap:8px;width:100%;background:#FEF3C7;color:#92400E;border:2px dashed #F59E0B;border-radius:10px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;box-sizing:border-box">
        üì∑ ${_fotoUrl ? 'Trocar Foto da Promo√ß√£o' : 'Adicionar Foto da Promo√ß√£o'}
        <input type="file" accept="image/*" style="display:none" onchange="onPromoFotoChange(this)">
      </label>
      <div style="font-size:11px;color:#9CA3AF;text-align:center;margin-top:4px">üìç <strong>Ideal: 1200 √ó 630 px</strong> (propor√ß√£o 16:9) ¬∑ JPG/PNG/WEBP ¬∑ m√°x 2 MB</div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üìù T√≠tulo da Promo√ß√£o <span style="color:#6B7280;font-weight:500">(m√°x. 50 caracteres)</span></div>
      <input id="promo-titulo" type="text" maxlength="50" value="${_ps.titulo||''}" placeholder="Ex: 50% OFF em Picol√©s!" oninput="validarCampoPromo(this,'promo-titulo',50,'titulo');salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:600;box-sizing:border-box">
      <div class="contador-chars contador-ok" id="cont-titulo">0 / 50</div>
      <div class="erro-inline" id="err-titulo">Campo obrigat√≥rio! M√≠nimo 3 caracteres.</div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üìÑ Descri√ß√£o <span style="color:#6B7280;font-weight:500">(m√°x. 150 caracteres)</span></div>
      <textarea id="promo-desc" rows="3" maxlength="150" placeholder="Descreva a promo√ß√£o..." oninput="validarCampoPromo(this,'promo-desc',150,'desc');salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:13px;resize:vertical;box-sizing:border-box">${_ps.descricao||''}</textarea>
      <div class="contador-chars contador-ok" id="cont-desc">0 / 150</div>
      <div class="erro-inline" id="err-desc"></div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üîò Nome do Bot√£o Principal <span style="color:#6B7280;font-weight:500">(m√°x. 25 caracteres)</span></div>
      <input id="promo-btn-nome" type="text" maxlength="25" value="${_ps.btnTexto||'üì∏ Ver no Instagram'}" placeholder="Ex: üõí Pedir Agora" oninput="validarCampoPromo(this,'promo-btn-nome',25,'btn');salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:600;box-sizing:border-box">
      <div class="contador-chars contador-ok" id="cont-btn">0 / 25</div>
      <div class="erro-inline" id="err-btn">M√°ximo de 25 caracteres atingido.</div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üîó Link do Bot√£o</div>
      <input id="promo-btn-link" type="url" value="${_ps.link||'https://www.instagram.com/sorveteriaitapolitanacajuru'}" placeholder="https://... ou /promocao.html" oninput="validarLink(this);salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:13px;box-sizing:border-box">
      <div class="erro-inline" id="err-link">URL inv√°lida. Deve come√ßar com https:// ou /</div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üìã Regulamento <span style="color:#6B7280;font-weight:500">(aparece no bot√£o da p√°gina de promo√ß√£o)</span></div>
      <textarea id="promo-regulamento" rows="5" placeholder="Ex: 1. Siga nosso perfil no Instagram...&#10;2. Marque 3 amigos nos coment√°rios...&#10;3. Resultado em 28/02/2026." oninput="salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:13px;resize:vertical;box-sizing:border-box;font-family:inherit">${_ps.regulamento||''}</textarea>
      <div style="font-size:11px;color:#6B7280;margin-top:3px">üí° Deixe em branco para ocultar o bot√£o de regulamento na p√°gina.</div>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:4px">üè∑Ô∏è Texto do Bot√£o Flutuante <span style="color:#6B7280;font-weight:500">(aparece na p√°gina inicial)</span></div>
      <input id="promo-fab-label-input" type="text" maxlength="20" value="${_ps.fabLabel||'üéâ SORTEIO!'}" placeholder="Ex: üéâ SORTEIO! ou üî• PROMO√á√ÉO!" oninput="salvarPromoLocal()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:600;box-sizing:border-box">
      <div style="font-size:11px;color:#6B7280;margin-top:3px">üí° M√°x. 20 caracteres. Aparece no bot√£o flutuante da p√°gina inicial.</div>
    </div>

    <div style="background:#FFF7ED;border:1.5px solid #FED7AA;border-radius:10px;padding:12px;margin-bottom:12px">
      <div style="font-size:13px;font-weight:800;color:#C2410C;margin-bottom:8px">‚è≥ Rel√≥gio Regressivo</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div style="font-size:11px;font-weight:700;color:#374151;margin-bottom:4px">üìÖ Data de T√©rmino</div>
          <input id="promo-data-fim" type="date" value="${_ps.dataFim||''}" oninput="salvarPromoLocal()" style="width:100%;padding:8px 10px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:13px;box-sizing:border-box">
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:#374151;margin-bottom:4px">üïê Hora de T√©rmino</div>
          <input id="promo-hora-fim" type="time" value="${_ps.horaFim||'22:00'}" oninput="salvarPromoLocal()" style="width:100%;padding:8px 10px;border:1.5px solid #E5E7EB;border-radius:8px;font-size:13px;box-sizing:border-box">
        </div>
      </div>
    </div>
    <button type="button" onclick="postarPromocao()" id="btn-postar-promo" style="width:100%;background:linear-gradient(135deg,#E8000D,#FF6B35);color:#fff;border:none;border-radius:12px;padding:16px;font-size:16px;font-weight:900;cursor:pointer;box-shadow:0 4px 16px rgba(232,0,13,.4);margin-bottom:8px">üì¢ Postar Promo√ß√£o no Site</button>
    <button type="button" onclick="desativarPromocao()" style="width:100%;background:#FEE2E2;color:#EF4444;border:1.5px solid #FECACA;border-radius:10px;padding:10px;font-size:13px;font-weight:700;cursor:pointer;margin-bottom:8px">üîï Desativar Promo√ß√£o</button>
    <a href="../promocao.html" target="_blank" style="display:block;text-align:center;background:#F3F4F6;color:#374151;border:1.5px solid #E5E7EB;border-radius:10px;padding:10px;font-size:13px;font-weight:700;text-decoration:none">üëÅÔ∏è Ver P√°gina da Promo√ß√£o</a>
    <div id="promo-status" style="margin-top:10px;font-size:13px;font-weight:700;color:#10B981;text-align:center"></div>
  `;
  body.appendChild(promoCard);
  // Inicializar contadores e valida√ß√µes com valores j√° salvos
  setTimeout(() => {
    const titulo = document.getElementById('promo-titulo');
    const desc = document.getElementById('promo-desc');
    const btn = document.getElementById('promo-btn-nome');
    const link = document.getElementById('promo-btn-link');
    if (titulo) validarCampoPromo(titulo, 'promo-titulo', 50, 'titulo');
    if (desc) validarCampoPromo(desc, 'promo-desc', 150, 'desc');
    if (btn) validarCampoPromo(btn, 'promo-btn-nome', 25, 'btn');
    if (link) validarLink(link);
  }, 100);
  const estoqueCard = document.createElement('div');
  estoqueCard.style.cssText = 'background:linear-gradient(135deg,#1F2937,#374151);border-radius:14px;padding:18px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;color:#fff;flex-wrap:wrap;gap:12px';
  estoqueCard.innerHTML = '<div><div style="font-size:15px;font-weight:800">üì¶ Estoque de Insumos</div><div style="font-size:12px;opacity:.85;margin-top:3px">Controle ingredientes, embalagens e materiais (at√© 300 itens)</div></div><a href="estoque.html" style="background:#10B981;color:#fff;border-radius:10px;padding:10px 18px;font-size:13px;font-weight:800;text-decoration:none;white-space:nowrap">üì¶ Abrir Estoque ‚Üí</a>';
  body.appendChild(estoqueCard);
  const bannerCard = document.createElement('div');
  bannerCard.style.cssText = 'background:#fff;border-radius:14px;border:2px solid #6A0DAD;padding:18px 20px;margin-bottom:16px';
  const bannerDados = (()=>{try{return JSON.parse(localStorage.getItem('itap_banner')||'{}');}catch(e){return {};}})();
  const temBanner = !!bannerDados.img;
  // Banner atual: se tiver no localStorage usa ele, sen√£o mostra o padr√£o do site
  const bannerSrc = temBanner ? bannerDados.img : '../images/banner-cardapio.png';
  bannerCard.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <span style="font-size:24px">üñºÔ∏è</span>
      <div>
        <div style="font-size:16px;font-weight:900;color:#6A0DAD">Banner do Site</div>
        <div style="font-size:12px;color:#6B7280;margin-top:2px">Aparece no topo do card√°pio. Substitua quando quiser.</div>
      </div>
    </div>
    <div id="banner-preview-area" style="margin-bottom:14px;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.12)">
      <img loading="lazy" src="${bannerSrc}" style="width:100%;max-height:200px;object-fit:cover;display:block" onerror="this.style.display='none'">
    </div>
    <div style="background:#EDE9FE;border:1px solid #C4B5FD;border-radius:10px;padding:10px 14px;margin-bottom:10px;font-size:12px;color:#5B21B6;font-weight:700;line-height:1.6">
      üìê <strong>Tamanho ideal:</strong> 1200 √ó 240 px (paisagem larga)<br>
      üì± Aparece no topo do card√°pio com altura m√°xima de 240 px<br>
      ‚úÖ Formatos aceitos: JPG, PNG, WEBP ‚Äî m√°x. recomendado: 500 KB
    </div>
    <label style="display:flex;align-items:center;justify-content:center;gap:8px;width:100%;background:linear-gradient(135deg,#6A0DAD,#9C27B0);color:#fff;border-radius:10px;padding:14px;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 4px 14px rgba(106,13,173,.4);margin-bottom:8px">
      üì∑ Substituir Banner do Site
      <input type="file" accept="image/*" style="display:none" onchange="onBannerChange(this)">
    </label>
    ${temBanner ? `<button type="button" onclick="removerBanner()" style="width:100%;background:#FEE2E2;color:#EF4444;border:1px solid #FECACA;border-radius:10px;padding:10px;font-size:13px;font-weight:700;cursor:pointer">üîÑ Restaurar Banner Padr√£o</button>` : ''}
    <div id="banner-status" style="margin-top:10px;font-size:13px;font-weight:700;color:#10B981;text-align:center"></div>
  `;
  body.appendChild(bannerCard);
  const saboresCard = document.createElement('div');
  saboresCard.style.cssText = 'background:#fff;border-radius:14px;border:2px solid #E8000D;padding:18px 20px;margin-bottom:16px';
  saboresCard.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <span style="font-size:24px">üç¶</span>
      <div>
        <div style="font-size:16px;font-weight:900;color:#E8000D">Sabores de Sorvete</div>
        <div style="font-size:12px;color:#6B7280;margin-top:2px">Gerencie os sabores dispon√≠veis no card√°pio e encomendas</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
      <input id="novo-sabor-input" type="text" placeholder="Nome do novo sabor..." style="flex:1;min-width:180px;padding:10px 14px;border:2px solid #E5E7EB;border-radius:10px;font-size:14px;outline:none" onfocus="this.style.borderColor='#E8000D'" onblur="this.style.borderColor='#E5E7EB'">
      <button type="button" onclick="adicionarSabor()" style="background:linear-gradient(135deg,#E8000D,#FF6B35);color:#fff;border:none;border-radius:10px;padding:10px 18px;font-size:14px;font-weight:800;cursor:pointer;white-space:nowrap">‚ûï Acrescentar</button>
    </div>
    <div id="lista-sabores-admin" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px"></div>
    <div id="sabores-status" style="margin-top:10px;font-size:13px;font-weight:700;color:#10B981;text-align:center"></div>
  `;
  body.appendChild(saboresCard);
  renderSaboresAdmin();

  body.appendChild(criarSecao('sorvetes', 'üç¶ Sorvetes de Massa', renderSorvetes()));
  body.appendChild(criarSecao('picoles', 'üç≠ Picol√©s', renderPicol√©s()));
  body.appendChild(criarSecao('acai', 'ü´ê A√ßa√≠ Artesanal', renderAcai()));
  body.appendChild(criarSecao('milkshake', 'ü•§ Milkshakes', renderMilkshake()));
  body.appendChild(criarSecao('tacas', 'üç® Ta√ßas', renderTacas()));
  body.appendChild(criarSecao('caixas', 'üì¶ Caixas de Viagem', renderCaixas()));
  body.appendChild(criarSecao('isopores', 'üßä Isopores de Viagem', renderIsopores()));
  body.appendChild(criarSecao('sobremesas', 'üéÇ Sobremesas', renderSobremesas()));
  body.appendChild(criarSecao('caixas_enc', 'üì¶ Caixas de Sorvete ‚Äì Encomenda (Estoque)', renderCaixasEnc()));
}
const CAIXAS_ENC_PADRAO = [
  { id:'cx5l_2s',  nome:'Caixa 5 Litros ‚Äì 2 Sabores',  preco:100.00, estoque:20, esgotado:false },
  { id:'cx5l_3s',  nome:'Caixa 5 Litros ‚Äì 3 Sabores',  preco:115.00, estoque:20, esgotado:false },
  { id:'cx10l_2s', nome:'Caixa 10 Litros ‚Äì 2 Sabores', preco:150.00, estoque:15, esgotado:false },
  { id:'cx10l_3s', nome:'Caixa 10 Litros ‚Äì 3 Sabores', preco:165.00, estoque:15, esgotado:false }
];
function getCaixasEnc() {
  try { const s = localStorage.getItem('itap_caixas_enc'); if(s) return JSON.parse(s); } catch(e){}
  return JSON.parse(JSON.stringify(CAIXAS_ENC_PADRAO));
}
function saveCaixasEnc(lista) {
  localStorage.setItem('itap_caixas_enc', JSON.stringify(lista));
}
function renderCaixasEnc() {
  const lista = getCaixasEnc();
  let html = '<div style="margin-bottom:12px;padding:10px 14px;background:#FFF7ED;border:1px solid #FED7AA;border-radius:10px;font-size:12px;color:#92400E;font-weight:600">üí° Quando o estoque chegar a 0 ou voc√™ clicar em <strong>Esgotar</strong>, a caixa fica indispon√≠vel para os clientes na p√°gina de encomendas.</div>';
  lista.forEach((c, i) => {
    const esgotado = c.esgotado || c.estoque <= 0;
    html += `<div style="background:${esgotado?'#FEF2F2':'#F9FAFB'};border:2px solid ${esgotado?'#FECACA':'#E5E7EB'};border-radius:12px;padding:14px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <span style="font-size:22px">üì¶</span>
        <span style="font-size:14px;font-weight:800;color:${esgotado?'#EF4444':'#111827'};flex:1">${c.nome}${esgotado?' ‚Äî <span style="color:#EF4444;font-size:12px">ESGOTADO</span>':''}</span>
        <button type="button" onclick="toggleEsgotadoCaixa(${i})" style="padding:6px 14px;border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;background:${esgotado?'#10B981':'#EF4444'};color:#fff">${esgotado?'‚úÖ Reativar':'‚ùå Esgotar'}</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Pre√ßo (R$)</label>
          <input type="number" step="0.01" min="0" value="${c.preco.toFixed(2)}" style="width:100%;padding:8px 10px;border:1px solid #E5E7EB;border-radius:7px;font-size:13px;font-weight:700" onchange="editarCaixaEnc(${i},'preco',parseFloat(this.value))">
        </div>
        <div>
          <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Estoque (caixas)</label>
          <input type="number" min="0" value="${c.estoque}" style="width:100%;padding:8px 10px;border:1px solid ${esgotado?'#FECACA':'#E5E7EB'};border-radius:7px;font-size:13px;font-weight:700;background:${esgotado?'#FEF2F2':'#fff'}" onchange="editarCaixaEnc(${i},'estoque',parseInt(this.value))">
        </div>
      </div>
    </div>`;
  });
  html += '<div id="caixas-enc-status" style="margin-top:8px;font-size:13px;font-weight:700;color:#10B981;text-align:center"></div>';
  return html;
}
function editarCaixaEnc(i, campo, val) {
  const lista = getCaixasEnc();
  lista[i][campo] = val;
  if(campo==='estoque') lista[i].esgotado = (val <= 0);
  saveCaixasEnc(lista);
  const status = document.getElementById('caixas-enc-status');
  if(status){ status.textContent = '‚úÖ '+lista[i].nome+' atualizado!'; setTimeout(()=>status.textContent='',3000); }
  const body = document.getElementById('cat-caixas_enc');
  if(body){ const bd = body.querySelector('.cat-body'); if(bd) bd.innerHTML = renderCaixasEnc(); }
}
function toggleEsgotadoCaixa(i) {
  const lista = getCaixasEnc();
  lista[i].esgotado = !lista[i].esgotado;
  if(lista[i].esgotado) lista[i].estoque = 0;
  saveCaixasEnc(lista);
  const body = document.getElementById('cat-caixas_enc');
  if(body){ const bd = body.querySelector('.cat-body'); if(bd) bd.innerHTML = renderCaixasEnc(); }
  const msg = lista[i].esgotado
    ? '‚ùå "'+lista[i].nome+'" ESGOTADO ‚Äî n√£o aparecer√° para clientes'
    : '‚úÖ "'+lista[i].nome+'" reativado com sucesso!';
  mostrarStatusComps(msg);
}
function renderSorvetes() {
  const p = produtos.sorvetes;
  const nomes = { casquinha_copo: 'Casquinha/Copo', copo_recheado: 'Copo Recheado', casc√£o: 'Casc√£o', cestinha: 'Cestinha' };
  let html = '<h4 style="margin-bottom:10px;font-size:13px;color:#6A0DAD">Pre√ßos por Apresenta√ß√£o</h4><div class="preco-simples-grid">';
  Object.entries(p.precos).forEach(([key, precos]) => {
    Object.entries(precos).forEach(([tam, preco]) => {
      const chave = 'sorvete_' + key + '_' + tam.replace(/\s/g,'_');
      html += `<div class="preco-simples-card">
        ${blocoFoto(chave)}
        <label>${nomes[key] || key} ‚Äì ${tam}</label>
        <input type="number" step="0.01" value="${preco}" onchange="produtos.sorvetes.precos['${key}']['${tam}']=parseFloat(this.value);autoSalvar()">
      </div>`;
    });
  });
  html += '</div><h4 style="margin:16px 0 10px;font-size:13px;color:#6A0DAD">Sabores (clique para marcar esgotado)</h4><div class="sabores-grid">';
  p.sabores.forEach(s => { html += `<span class="sabor-chip" onclick="this.classList.toggle('esgotado')">${s}</span>`; });
  html += '</div>';
  return html;
}
function renderPicol√©s() {
  let html = '<div class="prod-edit-grid">';
  Object.entries(produtos.picoles).forEach(([key, p]) => {
    const chave = 'picole_' + key;
    html += `<div class="prod-edit-card">
      ${blocoFoto(chave)}
      <h4>${p.nome}</h4>
      <div class="field-row">
        <div style="flex:1"><label>Varejo (R$)</label><input type="number" step="0.01" value="${p.preco_varejo}" onchange="produtos.picoles['${key}'].preco_varejo=parseFloat(this.value);autoSalvar()"></div>
        <div style="flex:1"><label>Atacado (R$)</label><input type="number" step="0.01" value="${p.preco_atacado}" onchange="produtos.picoles['${key}'].preco_atacado=parseFloat(this.value);autoSalvar()"></div>
      </div>
      <div class="field-row"><div style="flex:1"><label>Estoque</label><input type="number" min="0" max="200" value="${p.estoque}" onchange="produtos.picoles['${key}'].estoque=parseInt(this.value);autoSalvar()"></div></div>
      <div style="margin-top:8px;font-size:11px;color:#6A0DAD;font-weight:700">Sabores:</div>
      <div class="sabores-grid" style="margin-top:6px">${p.sabores.map(s => `<span class="sabor-chip" onclick="this.classList.toggle('esgotado')">${s}</span>`).join('')}</div>
      <button type="button" class="btn-esgotar" onclick="produtos.picoles['${key}'].estoque=0;this.closest('.prod-edit-card').querySelector('input[min]').value=0;this.classList.add('esgotado');this.textContent='‚ö†Ô∏è Esgotado'">Marcar Esgotado</button>
    </div>`;
  });
  html += '</div>';
  return html;
}
function renderAcai() {
  let html = '<h4 style="margin-bottom:10px;font-size:13px;color:#6A0DAD">Tamanhos de Copo</h4><div class="preco-simples-grid">';
  Object.entries(produtos.acai.copos).forEach(([tam, preco]) => {
    const chave = 'acai_' + tam.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>A√ßa√≠ ${tam}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.acai.copos['${tam}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div><h4 style="margin:16px 0 10px;font-size:13px;color:#6A0DAD">Complementos</h4>';
  const lbl = { frutas: 'üçì Frutas', cremes: 'üçØ Cremes', guloseimas: 'üç¨ Guloseimas', chocolates: 'üç´ Chocolates' };
  Object.entries(produtos.acai.complementos).forEach(([k, info]) => {
    html += `<div style="margin-bottom:16px;background:#FAFAFA;border:1px solid #E5E7EB;border-radius:12px;padding:12px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <span style="font-size:13px;font-weight:700;flex:1">${lbl[k] || k}</span>
        <span style="font-size:11px;color:#6A0DAD">Pre√ßo: R$</span>
        <input type="number" step="0.01" value="${info.preco}" style="width:70px;padding:4px 8px;border:1px solid #E5E7EB;border-radius:6px;font-size:13px" onchange="produtos.acai.complementos['${k}'].preco=parseFloat(this.value);autoSalvar()">
      </div>
      ${blocoFoto('acai_comp_'+k)}
      <div class="sabores-grid" style="margin-top:8px">${info.itens.map(i => `<span class="sabor-chip" onclick="this.classList.toggle('esgotado')">${i}</span>`).join('')}</div>
    </div>`;
  });
  return html;
}
function renderMilkshake() {
  const m = produtos.milkshake;
  let html = '<div class="preco-simples-grid">';
  Object.entries(m.tradicional).forEach(([tam, preco]) => {
    const chave = 'milk_trad_' + tam.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>Tradicional ${tam}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.milkshake.tradicional['${tam}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  Object.entries(m.top).forEach(([tam, preco]) => {
    const chave = 'milk_top_' + tam.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>Top ${tam}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.milkshake.top['${tam}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += `<div class="preco-simples-card">
    ${blocoFoto('milk_ovomaltine')}
    <label>Adicional Ovomaltine</label>
    <input type="number" step="0.01" value="${m.adicional_ovomaltine}" onchange="produtos.milkshake.adicional_ovomaltine=parseFloat(this.value);autoSalvar()">
  </div>`;
  html += '</div>';
  return html;
}
function renderTacas() {
  let html = '<h4 style="margin-bottom:10px;font-size:13px;color:#6A0DAD">Ta√ßas Tradicionais</h4><div class="preco-simples-grid">';
  Object.entries(produtos.tacas.tradicionais).forEach(([nome, preco]) => {
    const chave = 'taca_trad_' + nome.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>Ta√ßa ${nome}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.tacas.tradicionais['${nome}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div><h4 style="margin:16px 0 10px;font-size:13px;color:#6A0DAD">Ta√ßas Sujas</h4><div class="preco-simples-grid">';
  Object.entries(produtos.tacas.sujas).forEach(([nome, preco]) => {
    const chave = 'taca_suja_' + nome.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>Ta√ßa Suja ‚Äì ${nome}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.tacas.sujas['${nome}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div>';
  return html;
}
function renderCaixas() {
  let html = '<div class="preco-simples-grid">';
  Object.entries(produtos.caixas_viagem).forEach(([nome, preco]) => {
    const chave = 'caixa_' + nome.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>${nome}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.caixas_viagem['${nome}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div>';
  return html;
}
function renderIsopores() {
  let html = '<div class="preco-simples-grid">';
  Object.entries(produtos.isopores_viagem).forEach(([nome, preco]) => {
    const chave = 'isopore_' + nome.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>${nome}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.isopores_viagem['${nome}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div>';
  return html;
}
function renderSobremesas() {
  let html = '<div class="preco-simples-grid">';
  Object.entries(produtos.sobremesas).forEach(([nome, preco]) => {
    const chave = 'sobremesa_' + nome.replace(/\s/g,'_');
    html += `<div class="preco-simples-card">
      ${blocoFoto(chave)}
      <label>${nome}</label>
      <input type="number" step="0.01" value="${preco}" onchange="produtos.sobremesas['${nome}']=parseFloat(this.value);autoSalvar()">
    </div>`;
  });
  html += '</div>';
  return html;
}
const SABORES_PADRAO = [
  "Abacaxi ao Vinho","Abacaxi Su√≠√ßo","Algod√£o Doce (Blue Ice)","Amarena","Ameixa",
  "Banana com Nutella","Bis e Trufa","Cereja Trufada","Chocolate","Chocolate com Caf√©",
  "Coco Queimado","Creme Paris","Croquer","Doce de Leite","Ferrero Rocher",
  "Flocos","Kinder Ovo","Leite Condensado","Leite Ninho",
  "Leite Ninho Folheado","Leite Ninho com Oreo","Lim√£o",
  "Lim√£o Su√≠√ßo","Menta com Chocolate","Milho Verde","Morango Trufado",
  "Mousse de Maracuj√°","Mousse de Uva","Nozes","Nutella","Ovomaltine",
  "Pistache","Prest√≠gio","Sensa√ß√£o","Torta de Chocolate"
];

function getSaboresAdmin() {
  try {
    const salvo = localStorage.getItem('itap_sabores');
    if (salvo) return JSON.parse(salvo);
  } catch(e) {}
  const lista = SABORES_PADRAO.map(nome => ({ nome, esgotado: false }));
  localStorage.setItem('itap_sabores', JSON.stringify(lista));
  return lista;
}

function salvarSaboresAdmin(lista) {
  localStorage.setItem('itap_sabores', JSON.stringify(lista));
  if (produtos && produtos.sorvetes) {
    produtos.sorvetes.sabores = lista.filter(s => !s.esgotado).map(s => s.nome);
  }
}

function renderSaboresAdmin() {
  const container = document.getElementById('lista-sabores-admin');
  if (!container) return;
  const lista = getSaboresAdmin();
  container.innerHTML = lista.map((s, i) => `
    <div style="background:${s.esgotado ? '#FEF2F2' : '#F0FDF4'};border:1px solid ${s.esgotado ? '#FECACA' : '#BBF7D0'};border-radius:10px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
      <span style="font-size:13px;font-weight:700;color:${s.esgotado ? '#EF4444' : '#111827'};flex:1;${s.esgotado ? 'text-decoration:line-through' : ''}">${s.nome}</span>
      <div style="display:flex;gap:4px;flex-shrink:0">
        <button type="button" onclick="toggleEsgotadoSabor(${i})" style="padding:5px 10px;border:none;border-radius:7px;font-size:11px;font-weight:800;cursor:pointer;background:${s.esgotado ? '#10B981' : '#EF4444'};color:#fff">
          ${s.esgotado ? '‚úÖ Ativar' : '‚ùå Esgotar'}
        </button>
        <button type="button" onclick="excluirSabor(${i})" style="padding:5px 8px;border:none;border-radius:7px;font-size:11px;font-weight:800;cursor:pointer;background:#6B7280;color:#fff" title="Excluir">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}

function adicionarSabor() {
  const input = document.getElementById('novo-sabor-input');
  const nome = input.value.trim();
  if (!nome) { mostrarStatusSabores('‚ö†Ô∏è Digite o nome do sabor!'); return; }
  const lista = getSaboresAdmin();
  if (lista.find(s => s.nome.toLowerCase() === nome.toLowerCase())) {
    mostrarStatusSabores('‚ö†Ô∏è Sabor j√° existe na lista!'); return;
  }
  lista.push({ nome, esgotado: false });
  salvarSaboresAdmin(lista);
  input.value = '';
  renderSaboresAdmin();
  mostrarStatusSabores('‚úÖ Sabor "' + nome + '" adicionado com sucesso!');
}

function toggleEsgotadoSabor(idx) {
  const lista = getSaboresAdmin();
  lista[idx].esgotado = !lista[idx].esgotado;
  salvarSaboresAdmin(lista);
  renderSaboresAdmin();
  const status = lista[idx].esgotado ? '‚ùå "' + lista[idx].nome + '" marcado como ESGOTADO' : '‚úÖ "' + lista[idx].nome + '" reativado!';
  mostrarStatusSabores(status);
}

function excluirSabor(idx) {
  const lista = getSaboresAdmin();
  const nome = lista[idx].nome;
  if (!confirm('Excluir o sabor "' + nome + '" permanentemente?')) return;
  lista.splice(idx, 1);
  salvarSaboresAdmin(lista);
  renderSaboresAdmin();
  mostrarStatusSabores('üóëÔ∏è "' + nome + '" exclu√≠do permanentemente.');
}

function mostrarStatusSabores(msg) {
  const el = document.getElementById('sabores-status');
  if (el) { el.textContent = msg; setTimeout(() => el.textContent = '', 4000); }
}
const GIST_ID = '92bd9d1997c2fdd225ad3115c7028445';
const GIST_RAW = 'https://gist.githubusercontent.com/missias123/' + GIST_ID + '/raw/itap-produtos.json';
const PROXY_URL = 'https://5050-iws6e208zbbi8wf5hdl9t-69161701.us2.manus.computer/update-prices';

function getCaixasEnc() {
  try { return JSON.parse(localStorage.getItem('itap_caixas_enc') || 'null') || []; } catch(e) { return []; }
}

function _coletarDados() {
  return {
    picoles: produtos.picoles,
    caixas_enc: getCaixasEnc(),
    tortas_enc: JSON.parse(localStorage.getItem('itap_tortas_enc') || 'null') || [
      {id:'torta1',nome:'Torta de Sorvete',preco:100.00,maxSabores:3,estoque:10,esgotado:false}
    ],
    sorvetes_precos: produtos.sorvetes.precos,
    acai: produtos.acai,
    milkshake: produtos.milkshake,
    tacas: produtos.tacas,
    caixas_viagem: produtos.caixas_viagem,
    isopores_viagem: produtos.isopores_viagem,
    sobremesas: produtos.sobremesas
  };
}

let _autoSalvarTimer = null;
function autoSalvar() {
  clearTimeout(_autoSalvarTimer);
  _autoSalvarTimer = setTimeout(() => _enviarParaNuvem(), 1000);
}

async function _enviarParaNuvem() {
  const msg = document.getElementById('status-msg');
  // Limpa caches antigos antes de salvar novos dados
  limparTodosCaches();
  const dados = _coletarDados();
  localStorage.setItem('itap_produtos_nuvem', JSON.stringify(dados));
  msg.textContent = '‚òÅÔ∏è Salvando no site...';
  try {
    const resp = await fetch(PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Key': 'itap2007sync'
      },
      body: JSON.stringify(dados)
    });
    if (resp.ok) {
      msg.textContent = '‚úÖ Pre√ßos atualizados no site!';
    } else {
      msg.textContent = '‚ö†Ô∏è Erro no servidor ‚Äì salvo localmente';
    }
  } catch(e) {
    msg.textContent = '‚ö†Ô∏è Sem conex√£o ‚Äì salvo localmente';
  }
  setTimeout(() => msg.textContent = '', 4000);
}
// Token de sincronismo com GitHub ‚Äî salvo na mem√≥ria do navegador automaticamente
const _GHT = ['ghp','VZpatp5Y5SG2KgGDy6gpJQKBUxifbE1kkWij'].join('_');
let GITHUB_TOKEN = localStorage.getItem('itap_ghtoken') || _GHT;
const GITHUB_REPO = 'missias123/itapolitanacajuru';
async function _loadCfg() {
  if (!GITHUB_TOKEN) GITHUB_TOKEN = _GHT;
  // Salvar na mem√≥ria do navegador para uso futuro
  try { localStorage.setItem('itap_ghtoken', GITHUB_TOKEN); } catch(e) {}
}
// Fun√ß√£o para publicar dados diretamente no Gist (sem proxy)
async function publicarNoGist(gistId, nomeArquivo, dados) {
  // SOLU√á√ÉO DEFINITIVA: salva em dados/promo.json no reposit√≥rio (escopo repo)
  await _loadCfg();
  const REPO = 'missias123/itapolitanacajuru';
  const FILE = 'dados/promo.json';
  // Obter SHA atual
  let sha = null;
  try {
    const r = await fetch('https://api.github.com/repos/' + REPO + '/contents/' + FILE, {
      headers: { 'Authorization': 'token ' + GITHUB_TOKEN }
    });
    if (r.ok) { const d = await r.json(); sha = d.sha; }
  } catch(e) {}
  // Salvar arquivo
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(dados, null, 2))));
  const body = { message: 'Admin: atualizar promo.json', content, branch: 'main' };
  if (sha) body.sha = sha;
  const resp = await fetch('https://api.github.com/repos/' + REPO + '/contents/' + FILE, {
    method: 'PUT',
    headers: { 'Authorization': 'token ' + GITHUB_TOKEN, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!resp.ok) { const e = await resp.json(); throw new Error(e.message || 'Erro ao salvar'); }
  return await resp.json();
}
async function _publicarNoGist_OLD(gistId, nomeArquivo, dados) {
  const resp = await fetch('https://api.github.com/gists/' + gistId, {
    method: 'PATCH',
    headers: { 'Authorization': 'token ' + GITHUB_TOKEN, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
    body: JSON.stringify({ files: { [nomeArquivo]: { content: JSON.stringify(dados, null, 2) } } })
  });
  if (!resp.ok) { const err = await resp.json(); throw new Error('GitHub error: ' + (err.message || resp.status)); }
  return await resp.json();
}
// Fun√ß√£o para fazer upload de foto diretamente no reposit√≥rio GitHub
async function uploadFotoGitHub(base64DataUrl) {
  const matches = base64DataUrl.match(/^data:image\/(\w+);base64,(.+)$/);
  if (!matches) throw new Error('Formato de imagem inv√°lido');
  const ext = matches[1] === 'jpeg' ? 'jpg' : matches[1];
  const conteudo = matches[2];
  const nomeArquivo = 'fotos/promo-' + Date.now() + '.' + ext;
  // Verificar se arquivo j√° existe
  let sha = undefined;
  try {
    const check = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/contents/' + nomeArquivo, { headers: { 'Authorization': 'token ' + GITHUB_TOKEN } });
    if (check.ok) { const d = await check.json(); sha = d.sha; }
  } catch(e) {}
  const body = { message: 'foto: upload promo ' + new Date().toISOString(), content: conteudo };
  if (sha) body.sha = sha;
  const resp = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/contents/' + nomeArquivo, {
    method: 'PUT',
    headers: { 'Authorization': 'token ' + GITHUB_TOKEN, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!resp.ok) { const err = await resp.json(); throw new Error('GitHub upload error: ' + (err.message || resp.status) + ' ' + JSON.stringify(err)); }
  const result = await resp.json();
  return 'https://raw.githubusercontent.com/' + GITHUB_REPO + '/main/' + nomeArquivo + '?t=' + Date.now();
}
const GIST_PROMO_ID = 'f1b0cb83ecadc3c2e00da6f2d7aa3c42';
const GIST_PROMO_RAW = 'https://raw.githubusercontent.com/missias123/itapolitanacajuru/main/dados/promo.json';

function salvarPromoLocal() {
  const atual = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
  const d = {
    titulo: (document.getElementById('promo-titulo')||{}).value || '',
    descricao: (document.getElementById('promo-desc')||{}).value || '',
    btnTexto: (document.getElementById('promo-btn-nome')||{}).value || 'üì∏ Ver no Instagram',
    link: (document.getElementById('promo-btn-link')||{}).value || 'https://www.instagram.com/sorveteriaitapolitanacajuru',
    dataFim: (document.getElementById('promo-data-fim')||{}).value || '',
    horaFim: (document.getElementById('promo-hora-fim')||{}).value || '22:00',
    regulamento: (document.getElementById('promo-regulamento')||{}).value || '',
    fabLabel: (document.getElementById('promo-fab-label-input')||{}).value || 'üéâ SORTEIO!',
    fotoUrl: atual.fotoUrl || ''
  };
  localStorage.setItem('itap_promo_local', JSON.stringify(d));
}

// ‚îÄ‚îÄ COMPRESS√ÉO DE IMAGEM (canvas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Redimensiona para m√°x 1200px de largura e comprime para JPEG 80%
// Resultado: imagens de ~80-150 KB em vez de 2-5 MB
function comprimirImagem(file, maxW, maxH, qualidade) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = function(e) {
      const img = new Image();
      img.onerror = reject;
      img.onload = function() {
        let w = img.width, h = img.height;
        if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
        if (h > maxH) { w = Math.round(w * maxH / h); h = maxH; }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', qualidade));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}
function onPromoFotoChange(input) {
  const file = input.files[0];
  if (!file) return;
  const fotoStatus = document.getElementById('promo-foto-status');
  const promoStatus = document.getElementById('promo-status');
  if (fotoStatus) fotoStatus.textContent = '‚è≥ Comprimindo imagem...';
  comprimirImagem(file, 1200, 630, 0.82).then(async function(base64) {
    const preview = document.getElementById('promo-foto-preview');
    const img = document.getElementById('promo-foto-img');
    if (preview && img) { img.src = base64; preview.style.display = 'block'; }
    const kbOriginal = Math.round(file.size / 1024);
    const kbComprimido = Math.round(base64.length * 0.75 / 1024);
    if (fotoStatus) fotoStatus.textContent = `‚è≥ Enviando (${kbOriginal}KB ‚Üí ${kbComprimido}KB)...`;
    try {
      const url = await uploadFotoGitHub(base64);
      const d = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(ex){return {};}})();
      d.fotoUrl = url;
      localStorage.setItem('itap_promo_local', JSON.stringify(d));
      if (img) img.src = url;
      if (fotoStatus) fotoStatus.textContent = `‚úÖ Foto enviada! (${kbComprimido}KB) Clique em Postar.`;
      if (promoStatus) { promoStatus.textContent = 'üì∑ Foto pronta! Clique em Postar.'; setTimeout(() => promoStatus.textContent = '', 5000); }
    } catch(err) {
      if (fotoStatus) fotoStatus.textContent = '‚ùå Erro no upload: ' + err.message;
    }
  }).catch(function(err) {
    if (fotoStatus) fotoStatus.textContent = '‚ùå Erro ao processar imagem: ' + err.message;
  });
}

async function postarPromocao() {
  salvarPromoLocal();
  const d = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
  if (!d.titulo) { alert('Preencha pelo menos o t√≠tulo da promo√ß√£o!'); return; }
  const btn = document.getElementById('btn-postar-promo');
  const status = document.getElementById('promo-status');
  btn.textContent = '‚è≥ Publicando...';
  btn.disabled = true;
  d.ativo = true;
  delete d.imagem;
  delete d.bannerImg;
  try {
    await publicarNoGist(GIST_PROMO_ID, 'itap-promo.json', d);
    limparTodosCaches();
    status.textContent = '‚úÖ Promo√ß√£o publicada no site!';
    btn.textContent = '‚úÖ Publicado!';
    setTimeout(() => { btn.textContent = 'üì¢ Postar Promo√ß√£o no Site'; btn.disabled = false; status.textContent = ''; }, 4000);
  } catch(e) {
    status.textContent = '‚ö†Ô∏è Erro: ' + e.message;
    btn.textContent = 'üì¢ Postar Promo√ß√£o no Site';
    btn.disabled = false;
  }
}

async function desativarPromocao() {
  const status = document.getElementById('promo-status');
  status.textContent = '‚è≥ Desativando...';
  try {
    await publicarNoGist(GIST_PROMO_ID, 'itap-promo.json', { ativo: false });
    limparTodosCaches();
    status.textContent = 'üîï Promo√ß√£o desativada no site!';
    setTimeout(() => status.textContent = '', 4000);
  } catch(e) {
    status.textContent = '‚ö†Ô∏è Erro ao desativar: ' + e.message;
  }
}
// ‚îÄ‚îÄ LIMPEZA COMPLETA DE CACHE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Chamada automaticamente sempre que qualquer publica√ß√£o for feita no admin.
// Remove TODOS os caches antigos para garantir que o site exiba dados frescos.
function limparTodosCaches() {
  const chaves = [
    'itap_promo_cache',
    'itap_promo_local',
    'itap_banner_cache',
    'itap_banner',
    'itap_produtos_nuvem',
    'itap_fotos',
    'itap_sabores',
    'itap_caixas_enc',
    'itap_complementos',
    'itap_tortas_enc'
  ];
  chaves.forEach(k => localStorage.removeItem(k));
  console.log('[Admin] Caches antigos limpos:', chaves.join(', '));
}

function salvarTudo() {
  limparTodosCaches();
  _enviarParaNuvem();
}

// ‚îÄ‚îÄ VALIDA√á√ÉO EM TEMPO REAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function validarCampoPromo(el, id, max, tipo) {
  const val = el.value || '';
  const len = val.length;
  const contEl = document.getElementById('cont-' + tipo);
  const errEl = document.getElementById('err-' + tipo);
  // Atualiza contador
  if (contEl) {
    contEl.textContent = len + ' / ' + max;
    contEl.className = 'contador-chars ' + (len === 0 ? 'contador-ok' : len > max * 0.85 ? (len >= max ? 'contador-erro' : 'contador-aviso') : 'contador-ok');
  }
  // Valida√ß√£o visual do campo
  el.classList.remove('campo-valido', 'campo-invalido', 'campo-aviso');
  if (tipo === 'titulo') {
    if (len === 0) {
      el.classList.add('campo-aviso');
      if (errEl) { errEl.textContent = 'Campo obrigat√≥rio! M√≠nimo 3 caracteres.'; errEl.classList.add('visivel'); }
    } else if (len < 3) {
      el.classList.add('campo-invalido');
      if (errEl) { errEl.textContent = 'T√≠tulo muito curto. M√≠nimo 3 caracteres.'; errEl.classList.add('visivel'); }
    } else {
      el.classList.add('campo-valido');
      if (errEl) errEl.classList.remove('visivel');
    }
  } else if (tipo === 'btn') {
    if (len >= max) {
      el.classList.add('campo-invalido');
      if (errEl) { errEl.textContent = 'Limite de ' + max + ' caracteres atingido.'; errEl.classList.add('visivel'); }
    } else if (len > 0) {
      el.classList.add('campo-valido');
      if (errEl) errEl.classList.remove('visivel');
    }
  } else {
    if (len > 0) el.classList.add('campo-valido');
    if (errEl) errEl.classList.remove('visivel');
  }
}

function validarLink(el) {
  const val = (el.value || '').trim();
  const errEl = document.getElementById('err-link');
  el.classList.remove('campo-valido', 'campo-invalido', 'campo-aviso');
  if (!val) { return; }
  const valido = val.startsWith('https://') || val.startsWith('http://') || val.startsWith('/');
  if (valido) {
    el.classList.add('campo-valido');
    if (errEl) errEl.classList.remove('visivel');
  } else {
    el.classList.add('campo-invalido');
    if (errEl) errEl.classList.add('visivel');
  }
}

// ‚îÄ‚îÄ DIAGN√ìSTICO DO SISTEMA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _diagErros = [];

function toggleDiagnostico() {
  const painel = document.getElementById('painel-diagnostico');
  if (painel.classList.contains('aberto')) {
    painel.classList.remove('aberto');
    document.getElementById('btn-abrir-diag').textContent = 'üîç Diagn√≥stico';
  } else {
    painel.classList.add('aberto');
    document.getElementById('btn-abrir-diag').textContent = '‚ùå Fechar';
    executarDiagnostico();
  }
}

async function executarDiagnostico() {
  _diagErros = [];
  const res = document.getElementById('diag-resultados');
  res.innerHTML = '<div class="diag-item diag-info"><span>‚è≥</span><span>Executando diagn√≥stico...</span></div>';
  const itens = [];

  // 1. Verificar promo√ß√£o no reposit√≥rio GitHub
  try {
    const r = await fetch(GIST_PROMO_RAW + '?t=' + Date.now(), { cache: 'no-store' });
    if (r.ok) {
      const d = await r.json();
      itens.push({ tipo: 'ok', msg: '‚úÖ Sincronismo com GitHub: OK' });
      // Verificar se h√° dados corrompidos
      if (d.fotoUrl && d.fotoUrl.startsWith('data:')) {
        itens.push({ tipo: 'erro', msg: '‚ùå Foto corrompida: base64 detectado (muito pesado). Use o bot√£o Auto-Corrigir.' });
        _diagErros.push('foto_base64');
      } else if (d.fotoUrl && d.fotoUrl.trim()) {
        itens.push({ tipo: 'ok', msg: '‚úÖ Foto: URL v√°lida (' + d.fotoUrl.slice(0, 60) + '...)' });
      } else {
        itens.push({ tipo: 'aviso', msg: '‚ö†Ô∏è Foto: n√£o configurada (opcional)' });
      }
      if (d.ativo === false) {
        itens.push({ tipo: 'aviso', msg: '‚ö†Ô∏è Promo√ß√£o est√° DESATIVADA no site' });
      } else if (d.titulo) {
        itens.push({ tipo: 'ok', msg: '‚úÖ Promo√ß√£o ativa: "' + String(d.titulo).slice(0, 40) + '"' });
      } else {
        itens.push({ tipo: 'aviso', msg: '‚ö†Ô∏è Nenhuma promo√ß√£o configurada no site' });
      }
    } else {
      itens.push({ tipo: 'erro', msg: '‚ùå Arquivo de promo√ß√£o inacess√≠vel: HTTP ' + r.status });
      _diagErros.push('gist_inacessivel');
    }
  } catch(e) {
    itens.push({ tipo: 'erro', msg: '‚ùå Erro ao verificar promo√ß√£o: ' + e.message });
    _diagErros.push('gist_erro');
  }

  // 2. Verificar campos locais
  const titulo = document.getElementById('promo-titulo');
  const desc = document.getElementById('promo-desc');
  const btnNome = document.getElementById('promo-btn-nome');
  const btnLink = document.getElementById('promo-btn-link');

  if (titulo) {
    const v = titulo.value.trim();
    if (!v) { itens.push({ tipo: 'aviso', msg: '‚ö†Ô∏è T√≠tulo: n√£o preenchido' }); _diagErros.push('titulo_vazio'); }
    else if (v.length < 3) { itens.push({ tipo: 'erro', msg: '‚ùå T√≠tulo muito curto (' + v.length + ' chars). M√≠nimo 3.' }); _diagErros.push('titulo_curto'); }
    else if (v.length > 50) { itens.push({ tipo: 'erro', msg: '‚ùå T√≠tulo longo demais (' + v.length + ' chars). M√°x 50.' }); _diagErros.push('titulo_longo'); }
    else itens.push({ tipo: 'ok', msg: '‚úÖ T√≠tulo: OK (' + v.length + '/50 chars)' });
  }

  if (desc) {
    const v = desc.value.trim();
    if (v.length > 150) { itens.push({ tipo: 'erro', msg: '‚ùå Descri√ß√£o longa demais (' + v.length + ' chars). M√°x 150.' }); _diagErros.push('desc_longa'); }
    else if (v.length > 0) itens.push({ tipo: 'ok', msg: '‚úÖ Descri√ß√£o: OK (' + v.length + '/150 chars)' });
    else itens.push({ tipo: 'info', msg: '‚ÑπÔ∏è Descri√ß√£o: n√£o preenchida (opcional)' });
  }

  if (btnNome) {
    const v = btnNome.value.trim();
    if (v.length > 25) { itens.push({ tipo: 'erro', msg: '‚ùå Bot√£o longo demais (' + v.length + ' chars). M√°x 25.' }); _diagErros.push('btn_longo'); }
    else if (v.length > 0) itens.push({ tipo: 'ok', msg: '‚úÖ Bot√£o: OK (' + v.length + '/25 chars)' });
  }

  if (btnLink) {
    const v = btnLink.value.trim();
    if (v && !v.startsWith('https://') && !v.startsWith('http://') && !v.startsWith('/')) {
      itens.push({ tipo: 'erro', msg: '‚ùå Link inv√°lido: deve come√ßar com https:// ou /' });
      _diagErros.push('link_invalido');
    } else if (v) {
      itens.push({ tipo: 'ok', msg: '‚úÖ Link: OK' });
    }
  }

  // 3. Verificar token GitHub (sincronismo)
  try {
    const r = await fetch('https://api.github.com/repos/missias123/itapolitanacajuru', { headers: { 'Authorization': 'token ' + GITHUB_TOKEN }, cache: 'no-store' });
    if (r.ok) itens.push({ tipo: 'ok', msg: '‚úÖ Token GitHub: v√°lido e sincronismo funcionando' });
    else itens.push({ tipo: 'erro', msg: '‚ùå Token GitHub: erro ' + r.status + ' ‚Äî entre em contato com o suporte' });
  } catch(e) {
    itens.push({ tipo: 'aviso', msg: '‚ö†Ô∏è GitHub: sem conex√£o com internet' });
  }

  // Renderizar resultados
  res.innerHTML = itens.map(i => `<div class="diag-item diag-${i.tipo}"><span>${i.tipo==='ok'?'‚úÖ':i.tipo==='erro'?'‚ùå':i.tipo==='aviso'?'‚ö†Ô∏è':'‚ÑπÔ∏è'}</span><span>${i.msg}</span></div>`).join('');

  // Mostrar bot√£o de auto-corre√ß√£o se houver erros
  const btnCorr = document.getElementById('btn-autocorrigir');
  if (btnCorr) btnCorr.style.display = _diagErros.length > 0 ? 'block' : 'none';
}

async function autoCorrigir() {
  const btn = document.getElementById('btn-autocorrigir');
  btn.textContent = '‚è≥ Corrigindo...';
  btn.disabled = true;

  // Corrigir foto base64 no Gist
  if (_diagErros.includes('foto_base64')) {
    try {
      const d = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
      d.fotoUrl = ''; // Remove foto corrompida
      localStorage.setItem('itap_promo_local', JSON.stringify(d));
      await publicarNoGist(GIST_PROMO_ID, 'itap-promo.json', { ...d, fotoUrl: '' });
    } catch(e) {}
  }

  // Truncar campos que excedem o limite
  const titulo = document.getElementById('promo-titulo');
  const desc = document.getElementById('promo-desc');
  const btnNome = document.getElementById('promo-btn-nome');
  if (titulo && titulo.value.length > 50) { titulo.value = titulo.value.slice(0, 50); validarCampoPromo(titulo,'promo-titulo',50,'titulo'); }
  if (desc && desc.value.length > 150) { desc.value = desc.value.slice(0, 150); validarCampoPromo(desc,'promo-desc',150,'desc'); }
  if (btnNome && btnNome.value.length > 25) { btnNome.value = btnNome.value.slice(0, 25); validarCampoPromo(btnNome,'promo-btn-nome',25,'btn'); }

  // Limpar todos os caches
  limparTodosCaches();
  salvarPromoLocal();

  btn.textContent = '‚úÖ Corrigido!';
  setTimeout(() => {
    btn.textContent = 'üîß Auto-Corrigir Erros Detectados';
    btn.disabled = false;
    executarDiagnostico();
  }, 2000);
}

// ‚îÄ‚îÄ RELATO DE ERRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enviarRelato() {
  const campo = document.getElementById('campo-relato-erro');
  const status = document.getElementById('relato-status');
  const texto = (campo.value || '').trim();
  if (!texto) { status.textContent = '‚ö†Ô∏è Descreva o problema antes de enviar.'; return; }

  // Coletar dados t√©cnicos autom√°ticos
  const promo = (()=>{try{return JSON.parse(localStorage.getItem('itap_promo_local')||'{}');}catch(e){return {};}})();
  const dadosTec = [
    '--- RELATO DE ERRO ADMIN ---',
    'Data: ' + new Date().toLocaleString('pt-BR'),
    'Erro descrito: ' + texto,
    '',
    '--- DADOS T√âCNICOS ---',
    'Erros detectados: ' + (_diagErros.length ? _diagErros.join(', ') : 'nenhum'),
    'T√≠tulo atual: ' + (promo.titulo || '(vazio)'),
    'Descri√ß√£o: ' + (promo.descricao ? promo.descricao.slice(0,50)+'...' : '(vazio)'),
    'Foto URL: ' + (promo.fotoUrl ? (promo.fotoUrl.startsWith('data:') ? 'BASE64 CORROMPIDO' : promo.fotoUrl.slice(0,60)+'...') : '(sem foto)'),
    'Bot√£o: ' + (promo.btnTexto || '(vazio)'),
    'Link: ' + (promo.link || '(vazio)'),
    'Data fim: ' + (promo.dataFim || '(sem data)'),
    'Ativo: ' + (promo.ativo !== undefined ? promo.ativo : 'n√£o definido'),
    'User Agent: ' + navigator.userAgent.slice(0, 80)
  ].join('%0A');

  // Enviar via WhatsApp
  const wppUrl = 'https://wa.me/5516991472045?text=' + encodeURIComponent(
    'üö® RELATO DE ERRO ‚Äî ADMIN ITAPOLITANA\n\n' +
    'Erro: ' + texto + '\n\n' +
    'Erros detectados: ' + (_diagErros.length ? _diagErros.join(', ') : 'nenhum') + '\n' +
    'T√≠tulo: ' + (promo.titulo || '(vazio)') + '\n' +
    'Foto: ' + (promo.fotoUrl ? (promo.fotoUrl.startsWith('data:') ? 'BASE64 CORROMPIDO' : 'OK') : 'sem foto') + '\n' +
    'Data: ' + new Date().toLocaleString('pt-BR')
  );

  window.open(wppUrl, '_blank');
  status.textContent = '‚úÖ Relato aberto no WhatsApp!';
  campo.value = '';
  setTimeout(() => status.textContent = '', 5000);
}
</script>
<script src="../scripts/ortografia.js"></script>
</body>
</html>
